name: PR Merge Cleanup

on:
  pull_request:
    types:
      - closed

jobs:
  cleanup-after-merge:
    if: >
      github.event.pull_request.merged == true &&
      (
        github.event.pull_request.base.ref == 'dev' ||
        github.event.pull_request.base.ref == 'main'
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Close linked issues via gh CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
        shell: bash
        run: |
          echo "ğŸ” PR ë‚´ìš©ì—ì„œ ì´ìŠˆ ë‹«ëŠ” í‚¤ì›Œë“œë¥¼ ì°¾ëŠ” ì¤‘..."
          issue_count=0
          failed_count=0

          # ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ ë° ì¤‘ë³µ ì œê±°
          issue_numbers=$(printf '%s' "$PR_BODY" | tr -d '\r' | grep -Eoi '(close[sd]?|fix(e[sd])?|resolve[sd]?) #[0-9]+' | grep -oE '#[0-9]+' | tr -d '#' | sort -u)

          if [ -z "$issue_numbers" ]; then
            echo "â„¹ï¸  PR ë³¸ë¬¸ì—ì„œ ë‹«ì„ ì´ìŠˆë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."
            exit 0
          fi

          # ê° ì´ìŠˆ ì²˜ë¦¬
          while IFS= read -r issue_number; do
            if [ -n "$issue_number" ]; then
              echo "â¡ï¸  ë‹«ëŠ” ì¤‘: #$issue_number"
              if gh issue close "$issue_number" --reason completed --repo "$GITHUB_REPOSITORY"; then
                echo "âœ… ì´ìŠˆ #$issue_number ë‹«ê¸° ì™„ë£Œ"
                issue_count=$((issue_count + 1))
              else
                echo "âš ï¸  ì´ìŠˆ #$issue_number ë‹«ê¸° ì‹¤íŒ¨ (ì´ìŠˆê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)"
                failed_count=$((failed_count + 1))
              fi
            fi
          done <<< "$issue_numbers"

          echo "ğŸ“Š ì²˜ë¦¬ ê²°ê³¼: ì„±ê³µ $issue_countê°œ, ì‹¤íŒ¨ $failed_countê°œ"

      - name: Delete source branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        shell: bash
        run: |
          echo "ğŸ—‘ï¸  ì†ŒìŠ¤ ë¸Œëœì¹˜ ì‚­ì œ ì¤‘: $BRANCH_NAME"
          gh api repos/${{ github.repository }}/git/refs/heads/$BRANCH_NAME -X DELETE || echo "âš ï¸  ë¸Œëœì¹˜ ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨: $BRANCH_NAME"
