name: PR Merge Cleanup

on:
  pull_request:
    types:
      - closed

jobs:
  cleanup-after-merge:
    if: >
      github.event.pull_request.merged == true &&
      (
        github.event.pull_request.base.ref == 'dev' ||
        github.event.pull_request.base.ref == 'main'
      )
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Close linked issues via gh CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_BODY: ${{ github.event.pull_request.body }}
        shell: bash
        run: |
          echo "ğŸ” PR ë‚´ìš©ì—ì„œ ì´ìŠˆ ë‹«ëŠ” í‚¤ì›Œë“œë¥¼ ì°¾ëŠ” ì¤‘..."
          printf '%s' "$PR_BODY" | tr -d '\r' | grep -Eoi '(close[sd]?|fix(e[sd])?|resolve[sd]?) #[0-9]+' | while read -r match; do
            issue_number=$(echo "$match" | grep -oE '#[0-9]+' | tr -d '#')
            echo "â¡ï¸  ë‹«ëŠ” ì¤‘: #$issue_number"
            gh issue close "$issue_number" --reason completed --repo "$GITHUB_REPOSITORY"
          done

      - name: Delete source branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
        shell: bash
        run: |
          echo "ğŸ—‘ï¸  ì†ŒìŠ¤ ë¸Œëœì¹˜ ì‚­ì œ ì¤‘: $BRANCH_NAME"
          gh api repos/${{ github.repository }}/git/refs/heads/$BRANCH_NAME -X DELETE || echo "âš ï¸  ë¸Œëœì¹˜ ì‚­ì œ ì‹¤íŒ¨ ë˜ëŠ” ì´ë¯¸ ì‚­ì œë¨: $BRANCH_NAME"

